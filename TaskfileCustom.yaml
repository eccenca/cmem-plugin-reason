version: '3'

.preparation: &preparation
  deps:
    - poetry:install
    - check:prepare

tasks:

  check:prepare:
    internal: true
    summary: |
      prepare check targets by creating appropriate directory
    run: once
    cmds:
      - mkdir -p {{.DIST_DIR}}/coverage

  poetry:check:
    internal: true
    platforms: [ darwin, linux ]
    summary: |
      Check poetry versioning plugin. Currently not under Windows
    run: once
    preconditions:
      - sh: '[ -d .git ]'
        msg: >
          Your newly created project directory needs to be initialized
          as a git repository.
      - sh: '[[ {{.PDV_VERSION}} > {{.PDV_VERSION_MIN}} ]]'
        msg: >
          This project needs the poetry-dynamic-versioning
          plugin > v{{.PDV_VERSION_MIN}}.

          You can install it with the following command:
          poetry self add "poetry-dynamic-versioning[plugin]"
    vars:
      PDV_VERSION_MIN: 0.20
      PDV_VERSION:
        sh: >
          poetry self show --addons poetry-dynamic-versioning --tree
          | head -1 | cut -d " " -f 2 | cut -d "." -f 1-2

  poetry:install:
    desc: Install dependencies managed by Poetry
    run: once
    deps:
      - poetry:check
    cmds:
      - poetry install

  check:trivy:
    desc: Scan JAR binary for vulnerabilities using Trivy
    <<: *preparation
    cmds:
      - trivy rootfs --scanners vuln --format json --output {{.JSON_FILE}} {{.JAR_PATH}}
      - defer: rm -f {{.JSON_FILE}}
      - poetry run python trivy_to_junit.py {{.JSON_FILE}} {{.JUNIT_FILE}}
      - trivy rootfs --scanners vuln --severity HIGH,CRITICAL --exit-code 1 {{.JAR_PATH}}
    vars:
      JAR_PATH: cmem_plugin_reason/robot.jar
      JSON_FILE: ./{{.DIST_DIR}}/trivy-report.json
      JUNIT_FILE: ./{{.DIST_DIR}}/junit-trivy.xml
    preconditions:
      - sh: command -v trivy
        msg: "Trivy is not installed. Install it from https://trivy.dev/latest/getting-started/installation/"
      - sh: test -f {{.JAR_PATH}}
        msg: "JAR file not found at {{.JAR_PATH}}"
