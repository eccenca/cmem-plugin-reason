# https://taskfile.dev
---
version: '3'

tasks:
  check:trivy:
    desc: Scan JAR binary for vulnerabilities using Trivy
    deps:
      - poetry:install
      - check:prepare
    env:
      TRIVY_CACHE_DIR: /tmp/trivy
    cmds:
      - trivy rootfs --scanners vuln --format json --output {{.JSON_FILE}} {{.JAR_PATH}}
      - defer: rm -f {{.JSON_FILE}}
      - defer: rm -rf /tmp/trivy
      - poetry run python trivy_to_junit.py {{.JSON_FILE}} {{.JUNIT_FILE}}
      - trivy rootfs --scanners vuln --severity HIGH,CRITICAL --exit-code 1 {{.JAR_PATH}}
    vars:
      JAR_PATH: cmem_plugin_reason/robot.jar
      JSON_FILE: ./{{.DIST_DIR}}/trivy-report.json
      JUNIT_FILE: ./{{.DIST_DIR}}/junit-trivy.xml
    preconditions:
      - sh: command -v trivy
        msg: "Trivy is not installed. Install it from https://trivy.dev/latest/getting-started/installation/"
      - sh: test -f {{.JAR_PATH}}
        msg: "JAR file not found at {{.JAR_PATH}}"
